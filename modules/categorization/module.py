"""
–ú–æ–¥—É–ª—å 4: –ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è
–ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∏ —Ç–∏–ø—É
"""

import streamlit as st
from modules.categorization.moodle_parser import parse_moodle_file
from modules.categorization.categorizer import categorize_questions
from modules.categorization.moodle_generator import generate_moodle_file
from modules.categorization.visualizer import display_categorization_tree


def render():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –º–æ–¥—É–ª—è"""
    st.markdown("### üìÇ –ú–æ–¥—É–ª—å 4: –ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è")
    st.markdown("""
    **–û–ø–∏—Å–∞–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤ –±–∞–Ω–∫–∞ Moodle –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ (–∏–Ω–¥–µ–∫—Å –ª–µ–≥–∫–æ—Å—Ç–∏) –∏ —Ç–∏–ø—É –æ—Ç–≤–µ—Ç–∞ (–æ—Ç–∫—Ä—ã—Ç—ã–π/–∑–∞–∫—Ä—ã—Ç—ã–π). –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–π —Å—Ö–æ–∂–µ—Å—Ç–∏; –Ω–µ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—É—á–∞—é—Ç –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. –ü–æ—Ä–æ–≥ –≥—Ä–∞–Ω–∏—Ü—ã ¬´–ª—ë–≥–∫–∏–µ¬ª (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚â•70%) –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 65‚Äì75%.
    
    **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:**
    - **–ö–∞—Ç–µ–≥–æ—Ä–∏—è 1**: –õ–µ–≥–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã (>= 70%)
      - 1.1: –û—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã (—á–∏—Å–ª–æ–≤–æ–π –æ—Ç–≤–µ—Ç, –∫–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç)
      - 1.2: –ó–∞–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã (–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã)
    - **–ö–∞—Ç–µ–≥–æ—Ä–∏—è 2**: –°—Ä–µ–¥–Ω–∏–µ + —Å–ª–æ–∂–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã (< 70%)
      - 2.1: –û—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã
      - 2.2: –ó–∞–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã
    - **–ö–∞—Ç–µ–≥–æ—Ä–∏—è 3**: –ù–∞ –ø–µ—Ä–µ–¥–µ–ª–∫—É
      - –í–æ–ø—Ä–æ—Å—ã —Å –ø–ª–æ—Ö–æ–π –¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞—Ü–∏–µ–π (< 0.3)
      - 10% —Å–∞–º—ã—Ö –ª–µ–≥–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
      - –ú–∞–ª–æ –ø–æ–ø—ã—Ç–æ–∫ (–Ω–∏–∂–µ –ø–æ—Ä–æ–≥–∞ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏)
    """)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –º–æ–¥—É–ª—è 1
    if 'questions_data' not in st.session_state or not st.session_state['questions_data']:
        st.warning("""
        **‚ö†Ô∏è –î–ª—è —Ä–∞–±–æ—Ç—ã –º–æ–¥—É–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:**
        1. –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ **–ú–æ–¥—É–ª–µ 1: –ê–Ω–∞–ª–∏–∑ –≤–æ–ø—Ä–æ—Å–æ–≤**
        2. –ó–∞–≥—Ä—É–∑–∏—Ç—å Moodle GIFT —Ñ–∞–π–ª —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –≤ —ç—Ç–æ–º –º–æ–¥—É–ª–µ
        """)
        st.info("""
        **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:**
        1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É **üìà –ú–æ–¥—É–ª—å 1: –ê–Ω–∞–ª–∏–∑ –≤–æ–ø—Ä–æ—Å–æ–≤**
        2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (CSV –∏–ª–∏ HTML)
        3. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ —ç—Ç–æ—Ç –º–æ–¥—É–ª—å –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ Moodle GIFT —Ñ–∞–π–ª
        """)
        return
    
    # –ó–∞–≥—Ä—É–∑–∫–∞ Moodle —Ñ–∞–π–ª–∞
    st.markdown("---")
    st.markdown("### üì§ –ó–∞–≥—Ä—É–∑–∫–∞ Moodle GIFT —Ñ–∞–π–ª–∞")
    
    uploaded_file = st.file_uploader(
        "–ó–∞–≥—Ä—É–∑–∏—Ç–µ Moodle GIFT —Ñ–∞–π–ª —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏",
        type=['txt', 'gift'],
        help="–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª, —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–∑ Moodle –≤ —Ñ–æ—Ä–º–∞—Ç–µ GIFT",
        key="file_uploader_categorization"
    )
    
    if uploaded_file is not None:
        try:
            # –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª
            file_content = uploaded_file.read().decode('utf-8')
            
            # –ü–∞—Ä—Å–∏–º —Ñ–∞–π–ª
            base_category, moodle_questions = parse_moodle_file(file_content)
            
            st.success(f"‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω! –ù–∞–π–¥–µ–Ω–æ {len(moodle_questions)} –≤–æ–ø—Ä–æ—Å–æ–≤")
            
            # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏–∑ session_state
            analyzed_questions = st.session_state['questions_data']
            
            # –û–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å–ª–µ–≤–∞, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≥—Ä–∞–Ω–∏—Ü—ã —Å–ø—Ä–∞–≤–∞
            desc_col, slider_col = st.columns([1, 1])
            with desc_col:
                st.markdown("""
                **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:**
                - **–ö–∞—Ç–µ–≥–æ—Ä–∏—è 1**: –õ–µ–≥–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã (‚â• 70%)
                  - 1.1: –û—Ç–∫—Ä—ã—Ç—ã–µ (—á–∏—Å–ª–æ–≤–æ–π, –∫–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç)
                  - 1.2: –ó–∞–∫—Ä—ã—Ç—ã–µ (–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã)
                - **–ö–∞—Ç–µ–≥–æ—Ä–∏—è 2**: –°—Ä–µ–¥–Ω–∏–µ + —Å–ª–æ–∂–Ω—ã–µ (< 70%)
                  - 2.1: –û—Ç–∫—Ä—ã—Ç—ã–µ | 2.2: –ó–∞–∫—Ä—ã—Ç—ã–µ
                - **–ö–∞—Ç–µ–≥–æ—Ä–∏—è 3**: –ù–∞ –ø–µ—Ä–µ–¥–µ–ª–∫—É (–¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞—Ü–∏—è < 0,3; 10% —Å–∞–º—ã—Ö –ª—ë–≥–∫–∏—Ö; –º–∞–ª–æ –ø–æ–ø—ã—Ç–æ–∫)
                """)
            with slider_col:
                easy_threshold = st.slider(
                    "–ì—Ä–∞–Ω–∏—Ü–∞ ¬´–ª—ë–≥–∫–∏–µ¬ª (‚â•X%)",
                    min_value=65,
                    max_value=75,
                    value=70,
                    step=1,
                    help="–°–¥–≤–∏–≥ –≤–ª–µ–≤–æ ‚Äî –±–æ–ª—å—à–µ –≤ ¬´–ª—ë–≥–∫–∏–µ¬ª; –≤–ø—Ä–∞–≤–æ ‚Äî –º–µ–Ω—å—à–µ. –î–∏–∞–ø–∞–∑–æ–Ω 65‚Äì75%."
                )

            # –ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∏—Ä—É–µ–º –≤–æ–ø—Ä–æ—Å—ã
            with st.spinner("–ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤..."):
                categorized_questions, easiest_questions, unmatched_questions, duplicates_info, matching_info, low_attempts_questions = categorize_questions(moodle_questions, analyzed_questions, easy_threshold=easy_threshold)
            
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–∞–µ–º –∏—Ö)
            unmatched_action = "–í–∫–ª—é—á–∏—Ç—å –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—é —Å –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"
            if unmatched_questions:
                # –§–∏–ª—å—Ç—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ - –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–∞–µ–º –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã
                pass
            else:
                # –ï—Å–ª–∏ –≤—Å–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω—ã, –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –µ—Å—Ç—å
                pass
            
            # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
            st.markdown("---")
            display_categorization_tree(categorized_questions, easiest_questions, low_attempts_questions=low_attempts_questions, easy_threshold=easy_threshold)
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —Ñ–∞–π–ª
            st.markdown("---")
            st.markdown("### üíæ –≠–∫—Å–ø–æ—Ä—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞")
            
            new_file_content = generate_moodle_file(base_category, categorized_questions)
            
            st.download_button(
                label="üì• –°–∫–∞—á–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª",
                data=new_file_content,
                file_name=f"{base_category}_categorized.txt",
                mime="text/plain",
                key="download_categorized_file"
            )
            
            st.info("""
            **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏–º–ø–æ—Ä—Ç—É:**
            1. –°–∫–∞—á–∞–π—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª
            2. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –µ–≥–æ –æ–±—Ä–∞—Ç–Ω–æ –≤ Moodle —á–µ—Ä–µ–∑ –º–µ–Ω—é "–ò–º–ø–æ—Ä—Ç –≤–æ–ø—Ä–æ—Å–æ–≤"
            3. –í–æ–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            """)
            
        except Exception as e:
            st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞: {e}")
            st.exception(e)
