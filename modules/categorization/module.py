"""
–ú–æ–¥—É–ª—å 4: –ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è
–ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∏ —Ç–∏–ø—É
"""

import streamlit as st
from modules.categorization.moodle_parser import parse_moodle_file
from modules.categorization.categorizer import categorize_questions
from modules.categorization.moodle_generator import generate_moodle_file
from modules.categorization.visualizer import display_categorization_tree


def render():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –º–æ–¥—É–ª—è"""
    st.markdown("### üìÇ –ú–æ–¥—É–ª—å 4: –ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è")
    st.markdown("""
    **–û–ø–∏—Å–∞–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–∑ Moodle —Ñ–∞–π–ª–∞ –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∏ —Ç–∏–ø—É.
    
    –°–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞–µ—Ç –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞—Ç–µ–≥–æ—Ä–∏–π:
    - **–ö–∞—Ç–µ–≥–æ—Ä–∏—è 1**: –õ–µ–≥–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã (>= 70%)
      - 1.1: –û—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã (—á–∏—Å–ª–æ–≤–æ–π –æ—Ç–≤–µ—Ç, –∫–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç)
      - 1.2: –ó–∞–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã (–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–∏–ø—ã)
    - **–ö–∞—Ç–µ–≥–æ—Ä–∏—è 2**: –°—Ä–µ–¥–Ω–∏–µ + —Å–ª–æ–∂–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã (< 70%)
      - 2.1: –û—Ç–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã
      - 2.2: –ó–∞–∫—Ä—ã—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã
    - **–ö–∞—Ç–µ–≥–æ—Ä–∏—è 3**: –ù–∞ –ø–µ—Ä–µ–¥–µ–ª–∫—É
      - –í–æ–ø—Ä–æ—Å—ã —Å –ø–ª–æ—Ö–æ–π –¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞—Ü–∏–µ–π (< 0.3)
      - 10% —Å–∞–º—ã—Ö –ª–µ–≥–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
    """)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –º–æ–¥—É–ª—è 1
    if 'questions_data' not in st.session_state or not st.session_state['questions_data']:
        st.warning("""
        **‚ö†Ô∏è –î–ª—è —Ä–∞–±–æ—Ç—ã –º–æ–¥—É–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:**
        1. –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ **–ú–æ–¥—É–ª–µ 1: –ê–Ω–∞–ª–∏–∑ –≤–æ–ø—Ä–æ—Å–æ–≤**
        2. –ó–∞–≥—Ä—É–∑–∏—Ç—å Moodle GIFT —Ñ–∞–π–ª —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –≤ —ç—Ç–æ–º –º–æ–¥—É–ª–µ
        """)
        st.info("""
        **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:**
        1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É **üìà –ú–æ–¥—É–ª—å 1: –ê–Ω–∞–ª–∏–∑ –≤–æ–ø—Ä–æ—Å–æ–≤**
        2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (CSV –∏–ª–∏ HTML)
        3. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –≤ —ç—Ç–æ—Ç –º–æ–¥—É–ª—å –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ Moodle GIFT —Ñ–∞–π–ª
        """)
        return
    
    # –ó–∞–≥—Ä—É–∑–∫–∞ Moodle —Ñ–∞–π–ª–∞
    st.markdown("---")
    st.markdown("### üì§ –ó–∞–≥—Ä—É–∑–∫–∞ Moodle GIFT —Ñ–∞–π–ª–∞")
    
    uploaded_file = st.file_uploader(
        "–ó–∞–≥—Ä—É–∑–∏—Ç–µ Moodle GIFT —Ñ–∞–π–ª —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏",
        type=['txt', 'gift'],
        help="–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª, —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–∑ Moodle –≤ —Ñ–æ—Ä–º–∞—Ç–µ GIFT",
        key="file_uploader_categorization"
    )
    
    if uploaded_file is not None:
        try:
            # –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª
            file_content = uploaded_file.read().decode('utf-8')
            
            # –ü–∞—Ä—Å–∏–º —Ñ–∞–π–ª
            base_category, moodle_questions = parse_moodle_file(file_content)
            
            st.success(f"‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω! –ù–∞–π–¥–µ–Ω–æ {len(moodle_questions)} –≤–æ–ø—Ä–æ—Å–æ–≤")
            
            # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏–∑ session_state
            analyzed_questions = st.session_state['questions_data']
            
            # –ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∏—Ä—É–µ–º –≤–æ–ø—Ä–æ—Å—ã
            with st.spinner("–ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤..."):
                categorized_questions, easiest_questions, unmatched_questions, duplicates_info, matching_info = categorize_questions(moodle_questions, analyzed_questions)
            
            # –û—Ç–ª–∞–¥–æ—á–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–π
            with st.expander(f"üîç –û—Ç–ª–∞–¥–∫–∞: –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤ ({len(matching_info)})", expanded=False):
                import pandas as pd
                df_matching = pd.DataFrame(matching_info)
                # –î–æ–±–∞–≤–ª—è–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é
                df_matching.insert(0, '‚Ññ', range(1, len(df_matching) + 1))
                df_matching.columns = ['‚Ññ', 'ID –∏–∑ Moodle', 'ID –∏–∑ –∞–Ω–∞–ª–∏–∑–∞', '–î—É–±–ª—å']
                st.dataframe(df_matching, use_container_width=True, hide_index=True)
            
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–∞–µ–º –∏—Ö)
            unmatched_action = "–í–∫–ª—é—á–∏—Ç—å –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—é —Å –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"
            if unmatched_questions:
                # –§–∏–ª—å—Ç—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ - –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–∞–µ–º –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã
                pass
            else:
                # –ï—Å–ª–∏ –≤—Å–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω—ã, –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –µ—Å—Ç—å
                pass
            
            # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é
            st.markdown("---")
            display_categorization_tree(categorized_questions, easiest_questions)
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —Ñ–∞–π–ª
            st.markdown("---")
            st.markdown("### üíæ –≠–∫—Å–ø–æ—Ä—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞")
            
            new_file_content = generate_moodle_file(base_category, categorized_questions)
            
            st.download_button(
                label="üì• –°–∫–∞—á–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª",
                data=new_file_content,
                file_name=f"{base_category}_categorized.txt",
                mime="text/plain",
                key="download_categorized_file"
            )
            
            st.info("""
            **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏–º–ø–æ—Ä—Ç—É:**
            1. –°–∫–∞—á–∞–π—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª
            2. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –µ–≥–æ –æ–±—Ä–∞—Ç–Ω–æ –≤ Moodle —á–µ—Ä–µ–∑ –º–µ–Ω—é "–ò–º–ø–æ—Ä—Ç –≤–æ–ø—Ä–æ—Å–æ–≤"
            3. –í–æ–ø—Ä–æ—Å—ã –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            """)
            
        except Exception as e:
            st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞: {e}")
            st.exception(e)
