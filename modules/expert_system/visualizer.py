"""
–ú–æ–¥—É–ª—å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
"""

import streamlit as st
import plotly.graph_objects as go

from modules.expert_system.expert_system import generate_expert_analysis, compute_kbtb


def display_expert_system(questions):
    """–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã"""
    questions = [q for q in questions if not q.get('is_main_question', False)]
    try:
        expert_analysis = generate_expert_analysis(questions)
        
        if not expert_analysis:
            st.warning("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑")
            return
        
        # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ
        if expert_analysis.get('summary'):
            st.markdown("### üìã –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ")
            st.markdown(expert_analysis['summary'])
        
        # –ê–Ω–∞–ª–∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è - –ü–ï–†–í–´–ú
        match_analysis = expert_analysis.get('match_analysis', {})
        if match_analysis:
            st.markdown("### üéØ –ê–Ω–∞–ª–∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏")
            
            overlap_pct = match_analysis.get('overlap_percentage', 0)
            match_quality = match_analysis.get('match_quality', '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
            
            col1, col2 = st.columns(2)
            
            with col1:
                st.metric(
                    "–ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π", 
                    f"{overlap_pct:.1f}%",
                    help="–ü—Ä–æ—Ü–µ–Ω—Ç –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è –º–µ–∂–¥—É —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è–º–∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å—é –≤–æ–ø—Ä–æ—Å–æ–≤"
                )
            
            with col2:
                quality_color = {
                    '–æ—Ç–ª–∏—á–Ω–æ–µ': 'üü¢',
                    '—Ö–æ—Ä–æ—à–µ–µ': 'üü°', 
                    '—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ–µ': 'üü†',
                    '–ø–ª–æ—Ö–æ–µ': 'üî¥'
                }.get(match_quality, '‚ö™')
                
                st.metric(
                    "–ö–∞—á–µ—Å—Ç–≤–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è", 
                    f"{quality_color} {match_quality}",
                    help="–û—Ü–µ–Ω–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –º–µ–∂–¥—É —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è–º–∏ –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç—å—é"
                )
            
            # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—é
            match_recommendations = match_analysis.get('recommendations', [])
            if match_recommendations:
                st.markdown("**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—é:**")
                for rec in match_recommendations:
                    st.write(f"‚Ä¢ {rec}")
            
            # –°–ø—Ä–∞–≤–∫–∞ —Å —Ñ–æ—Ä–º—É–ª–æ–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ –ø–æ–∫—Ä—ã—Ç–∏—è - –ü–ï–†–ï–î –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º
            with st.expander("üìñ –°–ø—Ä–∞–≤–∫–∞: –§–æ—Ä–º—É–ª–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è"):
                st.markdown("""
                ### –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è (Overlap Index)
                
                –î–æ–ª—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π —Å—Ç—É–¥–µ–Ω—Ç–æ–≤, –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∞—è—Å—è —Å –¥–∏–∞–ø–∞–∑–æ–Ω–æ–º —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ —Ç–µ—Å—Ç–∞ (–≤ –ª–æ–≥–∏—Ç-—à–∫–∞–ª–µ).
                
                $$
                \\text{–ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ} = \\frac{L_{\\text{–ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ}}}{L_{\\text{–æ–±—â–∏–π}}} \\cdot 100\\%
                $$
                
                –≥–¥–µ:
                
                - $L_{\\text{–ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ}}$ ‚Äî –¥–ª–∏–Ω–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π —Å—Ç—É–¥–µ–Ω—Ç–æ–≤  
                - $L_{\\text{–æ–±—â–∏–π}}$ ‚Äî –æ–±—â–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω, –æ—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏–π –∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤, –∏ –≤–æ–ø—Ä–æ—Å—ã  
                
                **–ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∫–∞–∫:**
                
                $$
                L_{\\text{–ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ}} = \\max(0, \\min(\\theta_{\\max}, b_{\\max}) - \\max(\\theta_{\\min}, b_{\\min}))
                $$
                
                **–û–±—â–∏–π –¥–∏–∞–ø–∞–∑–æ–Ω:**
                
                $$
                L_{\\text{–æ–±—â–∏–π}} = \\max(\\theta_{\\max}, b_{\\max}) - \\min(\\theta_{\\min}, b_{\\min})
                $$
                
                –≥–¥–µ:
                - $\\theta_{\\min}, \\theta_{\\max}$ ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤  
                - $b_{\\min}, b_{\\max}$ ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å –≤–æ–ø—Ä–æ—Å–æ–≤
                """)
            
            # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –¥–ª—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π
            st.markdown("""
            **üìö –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –¥–ª—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π:**
            
            **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ö–æ—Ä–æ—à–æ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è –≤–∞—à–∏—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤.
            - **–í—ã—Å–æ–∫–æ–µ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ (>70%)**: –≤–æ–ø—Ä–æ—Å—ã —Ö–æ—Ä–æ—à–æ –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
            - **–ù–∏–∑–∫–æ–µ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ (<30%)**: –≤–æ–ø—Ä–æ—Å—ã —Å–ª–∏—à–∫–æ–º –ª–µ–≥–∫–∏–µ –∏–ª–∏ —Å–ª–æ–∂–Ω—ã–µ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
            
            **–ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è:**
            - **–û—Ç–ª–∏—á–Ω–æ–µ**: —Ç–µ—Å—Ç –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
            - **–•–æ—Ä–æ—à–µ–µ**: —Ç–µ—Å—Ç –≤ —Ü–µ–ª–æ–º –ø–æ–¥—Ö–æ–¥–∏—Ç, –µ—Å—Ç—å –Ω–µ–±–æ–ª—å—à–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
            - **–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ–µ**: —Ç–µ—Å—Ç –ø–æ–¥—Ö–æ–¥–∏—Ç, –Ω–æ –Ω—É–∂–Ω—ã —É–ª—É—á—à–µ–Ω–∏—è
            - **–ü–ª–æ—Ö–æ–µ**: —Ç–µ—Å—Ç –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤, —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–µ—Ä—å–µ–∑–Ω–∞—è –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞
            """)
        
        # KBTB ‚Äî –í–¢–û–†–´–ú –±–ª–æ–∫–æ–º
        _render_kbtb_block(questions)
        
        # –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (KBTB –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∂–µ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω ‚Äî target_level –≤ session_state)
        general_recommendations = expert_analysis.get('general_recommendations', [])
        target_level = st.session_state.get('kbtb_target_level') or {'L': 30, 'M': 50, 'H': 20}
        question_analysis = expert_analysis.get('question_analysis', {})
        n = question_analysis.get('total_questions', 0)
        easy_a, medium_a, hard_a = (
            question_analysis.get('easy_questions', 0),
            question_analysis.get('medium_questions', 0),
            question_analysis.get('hard_questions', 0),
        )
        if general_recommendations:
            st.markdown("### üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã")
            
            for rec in general_recommendations:
                # –ö–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ –±–∞–ª–∞–Ω—Å—É —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
                if "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ª–µ–≥–∫–∏—Ö" in rec:
                    add_hard = max(0, round(n * target_level.get('H', 20) / 100) - hard_a)
                    if add_hard > 0:
                        rec = f"{rec} (–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–æ +{add_hard} —Å–ª–æ–∂–Ω—ã—Ö)"
                elif "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —Å–ª–æ–∂–Ω—ã—Ö" in rec:
                    add_easy = max(0, round(n * target_level.get('L', 30) / 100) - easy_a)
                    if add_easy > 0:
                        rec = f"{rec} (–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–æ +{add_easy} –ª—ë–≥–∫–∏—Ö)"
                if "–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏" in rec.lower() or "–∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ" in rec.lower():
                    st.error(f"üö® **–ö—Ä–∏—Ç–∏—á–Ω–æ:** {rec}")
                elif "—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è" in rec.lower() or "—Å–ª–µ–¥—É–µ—Ç" in rec.lower():
                    st.warning(f"‚ö†Ô∏è **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** {rec}")
                else:
                    st.info(f"‚ÑπÔ∏è **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:** {rec}")
        
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞: {e}")
        st.write("–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É.")

def _render_kbtb_block(questions):
    """–ë–ª–æ–∫ KBTB: —Ü–µ–ª–µ–≤—ã–µ –¥–æ–ª–∏, —Ä–∞—Å—á—ë—Ç, –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è, —Ä–∞–∑–±–∏–≤–∫–∞ —à—Ç—Ä–∞—Ñ–æ–≤ –∏ –≥—Ä–∞—Ñ–∏–∫."""
    st.markdown("### ‚öñÔ∏è –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑—ã (KBTB)")

    with st.expander("üéØ –¶–µ–ª–µ–≤–∞—è –º–æ–¥–µ–ª—å (–¥–æ–ª–∏)", expanded=False):
        c1, c2 = st.columns(2)
        with c1:
            target_o = st.slider("–î–æ–ª—è –æ—Ç–∫—Ä—ã—Ç—ã—Ö (O), %", 0, 100, 40, key="kbtb_o")
            st.caption(f"–ó–∞–∫—Ä—ã—Ç—ã–µ (Z): {100 - target_o}%")
        with c2:
            min_q = st.number_input("–ú–∏–Ω. —á–∏—Å–ª–æ –≤–æ–ø—Ä–æ—Å–æ–≤ (0 = –Ω–µ —É—á–∏—Ç—ã–≤–∞—Ç—å)", 0, 1000, 0, key="kbtb_min")
        st.markdown("**–î–æ–ª–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ (L + M + H = 100%):**")
        l1, l2, l3 = st.columns(3)
        with l1:
            target_l = st.slider("–õ—ë–≥–∫–∏–µ (L), %", 0, 100, 30, key="kbtb_l")
        max_m = 100 - target_l
        with l2:
            target_m = st.slider("–°—Ä–µ–¥–Ω–∏–µ (M), %", 0, max(0, max_m), min(50, max_m), key="kbtb_m",
                                help="–û—Å—Ç–∞—Ç–æ–∫ –ø–æ—Å–ª–µ L —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –º–µ–∂–¥—É M –∏ H")
        target_h = 100 - target_l - target_m
        with l3:
            st.metric("–°–ª–æ–∂–Ω—ã–µ (H), %", target_h, help="–í—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: H = 100 ‚àí L ‚àí M")

    target_type = {'O': float(target_o), 'Z': float(100 - target_o)}
    target_level = {'L': float(target_l), 'M': float(target_m), 'H': float(target_h)}
    st.session_state['kbtb_target_level'] = target_level
    res = compute_kbtb(questions, target_type, target_level, min_questions=int(min_q))

    kbtb = res['kbtb']
    interp = res['interpretation']
    p_type = res['penalty_type']
    p_level = res['penalty_level']
    p_rework = res['penalty_rework']
    p_count = res['penalty_count']

    # –ò—Ç–æ–≥–æ–≤—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è
    st.metric("KBTB", f"{kbtb * 100:.1f}%", f"–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è: {interp}")
    # –†–∞–∑–±–∏–≤–∫–∞ —à—Ç—Ä–∞—Ñ–æ–≤
    st.markdown("**–í–ª–∏—è–Ω–∏–µ –Ω–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç:**")
    if p_type > 0.001:
        st.caption(f"‚àí{p_type * 100:.1f}% –∏–∑-–∑–∞ –ø–µ—Ä–µ–∫–æ—Å–∞ –ø–æ —Ç–∏–ø–∞–º –≤–æ–ø—Ä–æ—Å–æ–≤ (O/Z)")
    if p_level > 0.001:
        st.caption(f"‚àí{p_level * 100:.1f}% –∏–∑-–∑–∞ –ø–µ—Ä–µ–∫–æ—Å–∞ –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ (L/M/H)")
    if p_rework > 0.001:
        st.caption(f"‚àí{p_rework * 100:.1f}% –∏–∑-–∑–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–∞ –ø–µ—Ä–µ–¥–µ–ª–∫—É")
    if p_count > 0.001:
        st.caption(f"‚àí{p_count * 100:.1f}% –∏–∑-–∑–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–æ–ø—Ä–æ—Å–æ–≤")
    if p_type <= 0.001 and p_level <= 0.001 and p_rework <= 0.001 and p_count <= 0.001:
        st.caption("–®—Ç—Ä–∞—Ñ—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.")

    # –ì—Ä–∞—Ñ–∏–∫: —Ü–µ–ª–µ–≤—ã–µ vs —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ (O, Z, L, M, H)
    cats = ['O (–æ—Ç–∫—Ä—ã—Ç—ã–µ)', 'Z (–∑–∞–∫—Ä—ã—Ç—ã–µ)', 'L (–ª—ë–≥–∫–∏–µ)', 'M (—Å—Ä–µ–¥–Ω–∏–µ)', 'H (—Å–ª–æ–∂–Ω—ã–µ)']
    target_pct = [
        res['target_type']['O'] * 100, res['target_type']['Z'] * 100,
        res['target_level']['L'] * 100, res['target_level']['M'] * 100, res['target_level']['H'] * 100
    ]
    actual_pct = [
        res['actual_type']['O'] * 100, res['actual_type']['Z'] * 100,
        res['actual_level']['L'] * 100, res['actual_level']['M'] * 100, res['actual_level']['H'] * 100
    ]
    fig = go.Figure()
    fig.add_trace(go.Bar(name='–¶–µ–ª–µ–≤–∞—è –¥–æ–ª—è, %', x=cats, y=target_pct, marker_color='#3498db'))
    fig.add_trace(go.Bar(name='–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –¥–æ–ª—è, %', x=cats, y=actual_pct, marker_color='#e74c3c'))
    fig.update_layout(barmode='group', xaxis_tickangle=-30, height=320, margin=dict(t=20, b=80),
                      legend=dict(orientation='h', yanchor='bottom', y=1.02),
                      yaxis=dict(title='–î–æ–ª—è, %', range=[0, 105]))
    st.plotly_chart(fig, use_container_width=True)

    st.caption(f"–í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤: {res['n']}, –∏–∑ –Ω–∏—Ö ¬´–Ω–∞ –ø–µ—Ä–µ–¥–µ–ª–∫—É¬ª: {res['n_rework']} ({res['R']*100:.1f}%).")
    
    # –°–ø—Ä–∞–≤–∫–∞ —Å —Ñ–æ—Ä–º—É–ª–æ–π KBTB
    with st.expander("üìñ –°–ø—Ä–∞–≤–∫–∞: –§–æ—Ä–º—É–ª–∞ KBTB"):
        st.markdown("""
        ### –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑—ã (KBTB)
        
        $$
        \\text{–ö–ë–¢–ë} = 1 - w_1 \\cdot D_{\\text{—Ç–∏–ø}} - w_2 \\cdot D_{\\text{—É—Ä–æ–≤–µ–Ω—å}} - w_3 \\cdot P_{\\text{–ø–µ—Ä–µ–¥–µ–ª–∫–∞}} - w_4 \\cdot P_{\\text{–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ}}
        $$
        
        –≥–¥–µ:
        
        **–û—Ç–∫–ª–æ–Ω–µ–Ω–∏—è:**
        - $D_{\\text{—Ç–∏–ø}} = 0.5 \\cdot (|a_–û - t_–û| + |a_–ó - t_–ó|)$ ‚Äî –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º (–æ—Ç–∫—Ä—ã—Ç—ã–µ/–∑–∞–∫—Ä—ã—Ç—ã–µ)
        - $D_{\\text{—É—Ä–æ–≤–µ–Ω—å}} = 0.5 \\cdot (|a_–õ - t_–õ| + |a_–° - t_–°| + |a_–¢ - t_–¢|)$ ‚Äî –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ (–ª–µ–≥–∫–∏–µ/—Å—Ä–µ–¥–Ω–∏–µ/—Ç—Ä—É–¥–Ω—ã–µ)
        
        **–®—Ç—Ä–∞—Ñ—ã:**
        - $P_{\\text{–ø–µ—Ä–µ–¥–µ–ª–∫–∞}} = 1 - e^{-3R}$ ‚Äî —à—Ç—Ä–∞—Ñ –∑–∞ –≤–æ–ø—Ä–æ—Å—ã –Ω–∞ –ø–µ—Ä–µ–¥–µ–ª–∫—É
        - $P_{\\text{–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ}} = \\begin{cases} 0 & \\text{–µ—Å–ª–∏ } n \\geq n_{\\text{–º–∏–Ω}} \\\\ 1 - \\frac{n}{n_{\\text{–º–∏–Ω}}} & \\text{–∏–Ω–∞—á–µ} \\end{cases}$ ‚Äî —à—Ç—Ä–∞—Ñ –∑–∞ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤
        
        **–í–µ—Å–∞:** $w_1 = 0.3$, $w_2 = 0.3$, $w_3 = 0.2$, $w_4 = 0.2$
        
        **–û–±–æ–∑–Ω–∞—á–µ–Ω–∏—è:**
        - $a_–û, a_–ó$ ‚Äî —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –¥–æ–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã—Ö/–∑–∞–∫—Ä—ã—Ç—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
        - $t_–û, t_–ó$ ‚Äî —Ü–µ–ª–µ–≤—ã–µ –¥–æ–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã—Ö/–∑–∞–∫—Ä—ã—Ç—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
        - $a_–õ, a_–°, a_–¢$ ‚Äî —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –¥–æ–ª–∏ –ª–µ–≥–∫–∏—Ö/—Å—Ä–µ–¥–Ω–∏—Ö/—Ç—Ä—É–¥–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
        - $t_–õ, t_–°, t_–¢$ ‚Äî —Ü–µ–ª–µ–≤—ã–µ –¥–æ–ª–∏ –ª–µ–≥–∫–∏—Ö/—Å—Ä–µ–¥–Ω–∏—Ö/—Ç—Ä—É–¥–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
        - $R$ ‚Äî –¥–æ–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–∞ –ø–µ—Ä–µ–¥–µ–ª–∫—É
        - $n$ ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤
        - $n_{\\text{–º–∏–Ω}}$ ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ç—Ä–µ–±—É–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤
        
        **–ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è:** –ö–ë–¢–ë ‚àà [0, 1]; 1 ‚Äî –∏–¥–µ–∞–ª—å–Ω–∞—è —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å.
        """)
    
    st.markdown("---")